BootStrap: docker
From: ubuntu:18.04

%setup
cp ./install-rocm.sh ${SINGULARITY_ROOTFS}/install-rocm.sh
cp ./install-cuda.sh ${SINGULARITY_ROOTFS}/install-cuda.sh 
cp ./install-hipsycl.sh ${SINGULARITY_ROOTFS}/install-hipsycl.sh
cp ./install-llvm.sh ${SINGULARITY_ROOTFS}/install-llvm.sh
cp ./add-repo-ubuntu.sh ${SINGULARITY_ROOTFS}/add-repo-ubuntu.sh
cp ./install-cmake.sh ${SINGULARITY_ROOTFS}/install-cmake.sh 

%post
apt update
apt install -y libnuma-dev libpci-dev libelf-dev wget perl perl-modules gcc g++ git cmake clang mesa-common-dev
# required for aomp build
apt install -y iputils-ping gawk pkg-config python3 rsync

bash /add-repo-ubuntu.sh

apt download hipsycl-rocm
apt download hipsycl-base

bash /install-cuda.sh 
bash /install-cmake.sh
export PATH=/opt/cmake/cmake/bin/:$PATH
if [ "$HIPSYCL_PKG_BUILD_BASE" = "ON" ]; then 
   bash /install-llvm.sh
else
   pacman -Sdd --noconfirm hipSYCL-base
fi
if [ "$HIPSYCL_PKG_BUILD_ROCM" = "ON" ]; then 
   bash /install-rocm.sh
else
   pacman -Sdd --noconfirm hipSYCL-base
fi
