BootStrap: docker
From: archlinux/base

%setup
cp ./install-rocm.sh ${SINGULARITY_ROOTFS}/install-rocm.sh
cp ./install-cuda.sh ${SINGULARITY_ROOTFS}/install-cuda.sh 
cp ./install-hipsycl.sh ${SINGULARITY_ROOTFS}/install-hipsycl.sh
cp ./install-llvm.sh ${SINGULARITY_ROOTFS}/install-llvm.sh
cp ./add-repo-arch.sh ${SINGULARITY_ROOTFS}/add-repo-arch.sh
cp ./install-cmake.sh ${SINGULARITY_ROOTFS}/install-cmake.sh 

%post
[ "$HIPSYCL_PKG_BUILD_CUDA" = "ON" ] && bash /install-cuda.sh || echo "Not building CUDA"
echo "FROM INSIDE POST: $HIPSYCL_PKG_BUILD_ROCM"
pacman -Syu --noconfirm
pacman -S --noconfirm numactl pciutils libelf wget perl base-devel git cmake clang libglvnd
# required for aomp build
pacman -S --noconfirm  gawk pkg-config python3 rsync

# If we are not building rocm we need to pull it from the pkg repo.sh
bash /add-repo-arch.sh

bash /install-cuda.sh 
bash /install-cmake.sh
export PATH=/opt/cmake/cmake/bin/:$PATH
if [ "$HIPSYCL_PKG_BUILD_BASE" = "ON" ]; then 
   bash /install-llvm.sh
else
   pacman -Sdd --noconfirm hipSYCL-base
fi
if [ "$HIPSYCL_PKG_BUILD_ROCM" = "ON" ]; then 
   bash /install-rocm.sh
else
   pacman -Sdd --noconfirm hipSYCL-base
fi
